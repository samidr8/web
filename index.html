<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Libro Interactivo AR</title>
    <!-- Bibliotecas actualizadas -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="config-styles.css">
</head>

<body style="margin: 0; overflow: hidden;">
    <!-- Loader -->
    <div class="arjs-loader">
        <div>Cargando, por favor espere...</div>
    </div>

    <!-- Instrucciones para el usuario -->
    <div class="instructions" id="instructions">
        <div class="instructions-content">
            <h2>Instrucciones</h2>
            <p>Apunta la cámara a una IMAGEN del libro para ver contenido interactivo y espera unos segundos.</p>
            <p>Cada página activará diferentes tipos de contenido: modelos 3D, videos, test o aplicaciones
                interactivas.</p>
            <p><strong>Configuración:</strong> Usa el icono ⚙️ en la esquina superior derecha para acceder a opciones avanzadas.</p>
            <button onclick="document.getElementById('instructions').style.display='none'">Entendido</button>
        </div>
    </div>

    <!-- Indicador de estado - Nuevo -->
    <div id="status-indicator"></div>

    <!-- Título de contenido -->
    <div id="content-title"></div>

    <!-- Panel de información interactivo (HTML) - NUEVO -->
    <div id="info-panel" class="info-panel">
        <button class="info-panel-close" onclick="closeInfoPanel()">✕</button>
        <h3 id="info-panel-title">Título</h3>
        <div id="info-panel-content" class="info-panel-content">
            <img id="info-panel-image" class="info-panel-image" src="" alt="">
            <p id="info-panel-text">Contenido</p>
        </div>
    </div>

    <!-- Contenedor para iframe y su botón de cerrar -->
    <div id="web-content-container" class="web-content-container">
        <!-- MODIFICADO: Añadidos atributos para mejorar compatibilidad con GeoGebra -->
        <iframe id="web-content" class="web-content" allowfullscreen="true"
            allow="fullscreen; camera; microphone; clipboard-read; clipboard-write"
            sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"
            style="border:0; overflow:hidden; width:100%; height:100%;">
        </iframe>
        <button id="close-button" class="close-button" onclick="closeWebContent()">✕</button>
    </div>

    <!-- Pantalla de fallback para cuando iframe falla -->
    <div id="fallback-container" class="fallback-container">
        <h3>Esta página no permite ser mostrada en ventana integrada</h3>
        <p>El sitio web que intentas ver no permite ser mostrado dentro de esta aplicación.</p>
        <button class="btn" id="open-external-btn">Abrir en nueva ventana</button>
        <button class="btn btn-secondary" id="close-fallback-btn">Cancelar</button>
    </div>

    <!-- Contenedor para videos -->
    <div id="video-container" class="video-container">
        <div id="video-wrapper"></div>
        <button class="close-button" onclick="closeVideo()">✕</button>
    </div>

    <!-- Escena A-Frame con configuración NFT optimizada -->
    <a-scene vr-mode-ui="enabled: false;" renderer="logarithmicDepthBuffer: true; antialias: true;" embedded
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

        <!-- Los marcadores NFT se agregarán dinámicamente aquí -->
        <a-entity id="nft-markers-container"></a-entity>

        <!-- Cámara modificada: eliminado el cursor para evitar activaciones no deseadas -->
        <a-entity camera></a-entity>
    </a-scene>

    <script src="markers.js"></script>
    <script src="3d-functions.js"></script>
    <script src="video-functions.js"></script>
    <script src="web-functions.js"></script>
    <script src="main.js"></script>
    <script src="config-sensores.js"></script>
    
    <!-- AGREGADO: Script adicional para solucionar problemas con iframes -->
    <script>
        // Solución alternativa para GeoGebra
        document.addEventListener('DOMContentLoaded', function() {
            // Evitar que el foco en iframe cause problemas
            window.addEventListener('blur', function(e) {
                if (document.activeElement && document.activeElement.tagName === 'IFRAME') {
                    // Permitir foco en iframe sin interferir con AR.js
                    e.stopPropagation();
                }
            }, true);
            
            // Manejo especial para iframes
            const webContentContainer = document.querySelector('.web-content-container');
            const iframe = document.getElementById('web-content');
            
            // Evento para monitorear la carga del iframe
            iframe.addEventListener('load', function() {
                console.log('Iframe cargado correctamente');
                // Asegurarse de que el contenedor sea visible cuando el iframe se cargue
                webContentContainer.classList.add('visible');
            });
        });
    </script>
</body>

</html>