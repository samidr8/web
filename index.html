<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Aplicaci√≥n AR con Video</title>
  
  <!-- Favicon b√°sico para evitar error 404 -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé•</text></svg>">
  
  <!-- Cargar A-Frame y AR.js -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  
  <!-- Estilos CSS -->
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      touch-action: none;
    }
    
    .ui-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 100;
      pointer-events: none;
    }
    
    /* Pantalla de inicio */
    #startScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 999;
      padding: 20px;
      box-sizing: border-box;
      text-align: center;
    }
    
    #startScreen h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    
    #startScreen p {
      font-size: 16px;
      margin-bottom: 15px;
      max-width: 600px;
    }
    
    #startButton {
      background: #FF4081;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 30px;
      font-size: 18px;
      margin-top: 20px;
      cursor: pointer;
      pointer-events: auto;
      transition: transform 0.2s, background 0.2s;
      box-shadow: 0 4px 12px rgba(255, 64, 129, 0.5);
    }
    
    #startButton:hover {
      background: #F50057;
      transform: translateY(-2px);
    }
    
    /* Indicadores durante la experiencia AR */
    .ar-indicator {
      position: fixed;
      padding: 12px 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 30px;
      font-size: 14px;
      pointer-events: none;
      transition: opacity 0.3s;
      display: none;
    }
    
    #scanIndicator {
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    #tapIndicator {
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: auto;
    }
    
    #soundButton {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      display: none;
      pointer-events: auto;
      z-index: 100;
    }
    
    #backButton {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      display: none;
      pointer-events: auto;
      z-index: 100;
    }
    
    /* Pantalla de carga */
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 998;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #FF4081;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    #loadingText {
      color: white;
      margin-top: 20px;
      font-size: 16px;
    }
    
    /* Elemento de debug para desarrollo */
    #debugPanel {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      display: none;
      z-index: 101;
      max-width: 50%;
      overflow: auto;
      max-height: 30%;
    }
  </style>
</head>

<body>
  <!-- Pantalla de inicio -->
  <div id="startScreen">
    <h1>Experiencia de Video en Realidad Aumentada</h1>
    <p>Apunta tu c√°mara al marcador para ver el contenido de video en 3D.</p>
    <p>Aseg√∫rate de estar en un lugar con buena iluminaci√≥n y que el marcador est√© completamente visible.</p>
    <button id="startButton">COMENZAR EXPERIENCIA</button>
  </div>
  
  <!-- Pantalla de carga -->
  <div id="loadingScreen">
    <div class="spinner"></div>
    <div id="loadingText">Inicializando c√°mara...</div>
  </div>
  
  <!-- Interfaz durante la experiencia AR -->
  <div class="ui-container">
    <button id="backButton">‚Ü©</button>
    <button id="soundButton">üîä</button>
    <div id="scanIndicator" class="ar-indicator">Busca el marcador HIRO para ver el video</div>
    <div id="tapIndicator" class="ar-indicator">Toca aqu√≠ para activar el sonido</div>
  </div>
  
  <!-- Panel de debug (solo para desarrollo) -->
  <div id="debugPanel"></div>
  
  <!-- Escena AR -->
  <a-scene 
    id="arScene"
    embedded
    loading-screen="enabled: false"
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; sourceWidth: 640; sourceHeight: 480;"
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; precision: medium; antialias: true;"
    gesture-detector>
    
    <!-- Definici√≥n de assets -->
    <a-assets>
      <video 
        id="video-asset" 
        src="https://samidr8.github.io/web/sonidos_animales.mp4"
        preload="auto"
        muted
        crossorigin="anonymous"
        playsinline
        webkit-playsinline
        loop>
      </video>
    </a-assets>
    
    <!-- Marcador Hiro est√°ndar -->
    <a-marker 
      id="hiro-marker"
      preset="hiro"
      raycaster="objects: .clickable"
      emitevents="true"
      cursor="fuse: false; rayOrigin: mouse;"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.01"
      smoothThreshold="5">
      
      <!-- Plano de video - Corregida orientaci√≥n y posici√≥n -->
      <a-video
        id="video-plane"
        src="#video-asset"
        position="0 0.2 0"
        rotation="-90 0 0"
        width="1.6"
        height="0.9"
        class="clickable">
      </a-video>
      
      <!-- Base del video para darle contexto -->
      <a-box 
        position="0 0.1 0" 
        width="1.8" 
        height="0.01" 
        depth="1.1" 
        opacity="0.7"
        color="#333333">
      </a-box>
    </a-marker>
    
    <!-- C√°mara con cursor -->
    <a-entity camera></a-entity>
  </a-scene>
  
  <!-- Scripts -->
  <script>
    // Elementos DOM
    const startScreen = document.getElementById('startScreen');
    const loadingScreen = document.getElementById('loadingScreen');
    const startButton = document.getElementById('startButton');
    const backButton = document.getElementById('backButton');
    const scanIndicator = document.getElementById('scanIndicator');
    const tapIndicator = document.getElementById('tapIndicator');
    const soundButton = document.getElementById('soundButton');
    const debugPanel = document.getElementById('debugPanel');
    const videoElement = document.getElementById('video-asset');
    const scene = document.querySelector('a-scene');
    const marker = document.getElementById('hiro-marker');
    
    // Variables de estado
    let appState = {
      cameraReady: false,
      markerVisible: false,
      videoReady: false,
      audioUnlocked: false,
      debug: true // Activado para ayudar a diagnosticar problemas
    };
    
    // Funciones de utilidad para debug
    function debug(message) {
      if (appState.debug) {
        console.log(`[AR-DEBUG] ${message}`);
        debugPanel.innerHTML = `${new Date().toLocaleTimeString()}: ${message}<br>` + debugPanel.innerHTML;
        
        // Limitar el n√∫mero de mensajes en el panel
        const maxLines = 20;
        const lines = debugPanel.innerHTML.split('<br>');
        if (lines.length > maxLines) {
          debugPanel.innerHTML = lines.slice(0, maxLines).join('<br>');
        }
      }
    }
    
    // Inicializaci√≥n de la aplicaci√≥n
    function initApp() {
      if (appState.debug) {
        debugPanel.style.display = 'block';
      }
      
      // Configurar eventos del video
      setupVideoEvents();
      
      // Configurar eventos del marcador
      setupMarkerEvents();
      
      // Configurar eventos de la escena
      scene.addEventListener('loaded', onSceneLoaded);
      
      // Agregar informaci√≥n del navegador al debug
      debug(`Navegador: ${navigator.userAgent}`);
      
      // Verificar si estamos en HTTP o HTTPS
      if (window.location.protocol !== 'https:') {
        debug('ADVERTENCIA: La aplicaci√≥n no est√° en HTTPS. Algunas caracter√≠sticas pueden no funcionar.');
        
        // En algunos navegadores, getUserMedia solo funciona en HTTPS
        if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
          alert('Para acceder a la c√°mara, esta p√°gina debe ejecutarse en HTTPS. Por favor, carga la p√°gina utilizando HTTPS.');
        }
      }
      
      // Evento del bot√≥n de inicio
      startButton.addEventListener('click', startExperience);
      
      // Evento del bot√≥n de regreso
      backButton.addEventListener('click', resetExperience);
      
      // Eventos para desbloquear audio
      tapIndicator.addEventListener('click', unlockAudio);
      soundButton.addEventListener('click', unlockAudio);
      
      debug('Aplicaci√≥n inicializada');
    }
    
    // Cuando se carga la escena AR
    function onSceneLoaded() {
      debug('Escena AR cargada');
      
      // Precarga del video
      videoElement.load();
      videoElement.muted = true;
      
      // Verificar compatibilidad con AR
      checkARCompatibility();
    }
    
    // Verificar compatibilidad del dispositivo con AR
    function checkARCompatibility() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Tu dispositivo o navegador no es compatible con experiencias de Realidad Aumentada. Se requiere acceso a la c√°mara.');
        debug('Dispositivo no compatible con AR - Sin mediaDevices API');
        return false;
      }
      
      // Verificar si hay c√°maras disponibles
      if (navigator.mediaDevices.enumerateDevices) {
        navigator.mediaDevices.enumerateDevices()
          .then(devices => {
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            if (videoDevices.length === 0) {
              alert('No se detectaron c√°maras en tu dispositivo.');
              debug('No se detectaron c√°maras');
              return false;
            } else {
              debug(`C√°maras detectadas: ${videoDevices.length}`);
              videoDevices.forEach((device, index) => {
                debug(`C√°mara ${index + 1}: ${device.label || 'sin etiqueta'}`);
              });
            }
          })
          .catch(err => {
            debug(`Error al enumerar dispositivos: ${err.message}`);
          });
      }
      
      debug('Dispositivo compatible con AR');
      return true;
    }
    
    // Iniciar la experiencia AR
    function startExperience() {
      debug('Iniciando experiencia AR');
      
      // Mostrar pantalla de carga
      startScreen.style.display = 'none';
      loadingScreen.style.display = 'flex';
      loadingText.textContent = 'Solicitando acceso a la c√°mara...';
      
      // Inicializar la c√°mara con tiempo m√°ximo de 15 segundos
      let cameraTimeout = setTimeout(() => {
        debug('Tiempo de espera de c√°mara excedido');
        loadingScreen.style.display = 'none';
        startScreen.style.display = 'flex';
        alert('No se pudo acceder a la c√°mara. Por favor, verifica los permisos e int√©ntalo de nuevo.');
      }, 15000);
      
      // Opciones avanzadas para la c√°mara
      const cameraConstraints = { 
        audio: false,
        video: { 
          facingMode: 'environment', // Usar c√°mara trasera
          width: { ideal: 640 },     // Resoluci√≥n m√°s baja para mejor rendimiento
          height: { ideal: 480 },
          frameRate: { ideal: 30 }   // Frames por segundo
        } 
      };
      
      // Intentar primero con c√°mara trasera
      navigator.mediaDevices.getUserMedia(cameraConstraints)
        .then(handleCameraSuccess)
        .catch(error => {
          debug(`Error con c√°mara trasera: ${error.message}. Intentando con c√°mara frontal...`);
          loadingText.textContent = 'Intentando con c√°mara alternativa...';
          
          // Intentar con c√°mara frontal como respaldo
          const fallbackConstraints = { 
            audio: false,
            video: { 
              facingMode: 'user',    // C√°mara frontal
              width: { ideal: 640 }, 
              height: { ideal: 480 } 
            } 
          };
          
          navigator.mediaDevices.getUserMedia(fallbackConstraints)
            .then(handleCameraSuccess)
            .catch(handleCameraError);
        });
      
      // Funci√≥n para manejar conexi√≥n exitosa de c√°mara
      function handleCameraSuccess(stream) {
        clearTimeout(cameraTimeout);
        debug('C√°mara inicializada correctamente');
        
        // Guardar referencia al stream para limpieza posterior
        appState.cameraStream = stream;
        appState.cameraReady = true;
        
        // Ocultar pantalla de carga
        loadingScreen.style.display = 'none';
        
        // Mostrar indicadores y botones de la UI
        backButton.style.display = 'block';
        scanIndicator.style.display = 'block';
        soundButton.style.display = 'block';
        setTimeout(() => {
          tapIndicator.style.display = 'block';
        }, 3000);
      }
      
      // Funci√≥n para manejar error de c√°mara
      function handleCameraError(error) {
        clearTimeout(cameraTimeout);
        debug(`Error de c√°mara: ${error.message}`);
        
        loadingScreen.style.display = 'none';
        startScreen.style.display = 'flex';
        
        // Mensaje de error espec√≠fico seg√∫n el tipo de error
        let errorMsg = 'No se pudo acceder a la c√°mara: ';
        
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
          errorMsg += 'Permisos denegados. Por favor, permite el acceso a la c√°mara en tu navegador.';
        } else if (error.name === 'NotFoundError') {
          errorMsg += 'No se encontr√≥ ninguna c√°mara en el dispositivo.';
        } else if (error.name === 'NotReadableError' || error.name === 'AbortError') {
          errorMsg += 'La c√°mara est√° siendo usada por otra aplicaci√≥n o no est√° disponible.';
        } else if (error.name === 'OverconstrainedError') {
          errorMsg += 'Las configuraciones de c√°mara solicitadas no son compatibles con tu dispositivo.';
        } else if (error.name === 'SecurityError') {
          errorMsg += 'El uso de la c√°mara fue bloqueado por pol√≠ticas de seguridad.';
        } else if (error.name === 'TypeError') {
          errorMsg += 'No se especificaron configuraciones v√°lidas para la c√°mara.';
        } else {
          errorMsg += error.message || 'Error desconocido.';
        }
        
        alert(errorMsg);
      }
    }
    
    // Configurar eventos del video
    function setupVideoEvents() {
      debug('Configurando eventos de video');
      
      videoElement.addEventListener('loadeddata', () => {
        debug('Video cargado y listo para reproducci√≥n');
        appState.videoReady = true;
        
        // Si el marcador ya est√° visible, reproducir el video
        if (appState.markerVisible) {
          playVideo();
        }
      });
      
      videoElement.addEventListener('play', () => {
        debug('Video reproduciendo');
      });
      
      videoElement.addEventListener('pause', () => {
        debug('Video pausado');
      });
      
      videoElement.addEventListener('error', (e) => {
        debug(`Error en video: ${videoElement.error ? videoElement.error.message : 'Desconocido'}`);
      });
    }
    
    // Configurar eventos del marcador
    function setupMarkerEvents() {
      debug('Configurando eventos de marcador');
      
      marker.addEventListener('markerFound', () => {
        debug('Marcador encontrado');
        appState.markerVisible = true;
        scanIndicator.style.display = 'none';
        
        // Mostrar indicador de sonido si no est√° desbloqueado
        if (!appState.audioUnlocked) {
          tapIndicator.style.display = 'block';
        }
        
        // Si el video est√° listo, reproducirlo
        if (appState.videoReady) {
          playVideo();
        }
      });
      
      marker.addEventListener('markerLost', () => {
        debug('Marcador perdido');
        appState.markerVisible = false;
        scanIndicator.style.display = 'block';
        tapIndicator.style.display = 'none';
        
        // Pausar el video
        videoElement.pause();
      });
    }
    
    // Reproducir el video
    function playVideo() {
      if (!appState.markerVisible || !appState.videoReady) {
        debug('No se puede reproducir: marcador no visible o video no listo');
        return;
      }
      
      debug('Intentando reproducir video...');
      
      // Reiniciar si necesario
      if (videoElement.ended) {
        videoElement.currentTime = 0;
      }
      
      // Aplicar estado de audio seg√∫n la configuraci√≥n actual
      if (appState.audioUnlocked) {
        videoElement.muted = false;
      }
      
      // Intentar reproducir
      const playPromise = videoElement.play();
      
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            debug('Reproducci√≥n exitosa');
            
            // Si ya est√° desbloqueado el audio, asegurarse de quitar el mute
            if (appState.audioUnlocked) {
              videoElement.muted = false;
            }
          })
          .catch(error => {
            debug(`Error en reproducci√≥n: ${error}`);
            
            // Intentar con mute si fall√≥
            if (!videoElement.muted) {
              debug('Intentando reproducir con mute por pol√≠tica autoplay');
              videoElement.muted = true;
              videoElement.play().catch(e => {
                debug(`Fallo incluso con mute: ${e}`);
              });
            }
          });
      }
    }
    
    // Desbloquear audio (necesario en iOS/Safari)
    function unlockAudio() {
      debug('Desbloqueando audio');
      
      // Crear un contexto de audio (necesario para iOS)
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (AudioContext) {
        const audioCtx = new AudioContext();
        // Oscilador silencioso para activar el audio
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        gainNode.gain.value = 0;
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start(0);
        oscillator.stop(0.001);
      }
      
      // Quitar mute al video si est√° reproduci√©ndose
      videoElement.muted = false;
      
      // Reproducir el video con sonido si est√° visible
      if (appState.markerVisible && !videoElement.paused) {
        debug('Reactivando video con sonido');
        // Reiniciar reproducci√≥n para aplicar cambio de mute
        const currentTime = videoElement.currentTime;
        videoElement.pause();
        videoElement.currentTime = currentTime;
        videoElement.muted = false;
        videoElement.play();
      }
      
      appState.audioUnlocked = true;
      tapIndicator.style.display = 'none';
      soundButton.textContent = 'üîä';
      debug('Audio desbloqueado');
    }
    
    // Reiniciar la experiencia
    function resetExperience() {
      debug('Reiniciando experiencia');
      
      // Detener video
      videoElement.pause();
      videoElement.currentTime = 0;
      
      // Detener stream de c√°mara
      if (appState.cameraStream && appState.cameraStream.getTracks) {
        appState.cameraStream.getTracks().forEach(track => track.stop());
      }
      
      // Ocultar elementos de UI
      backButton.style.display = 'none';
      scanIndicator.style.display = 'none';
      tapIndicator.style.display = 'none';
      soundButton.style.display = 'none';
      
      // Restablecer estado
      appState.markerVisible = false;
      appState.cameraReady = false;
      appState.audioUnlocked = false;
      
      // Volver a pantalla de inicio
      startScreen.style.display = 'flex';
      
      // Recargar para reiniciar AR.js completamente
      location.reload();
    }
    
    // Gesti√≥n de errores globales
    window.addEventListener('error', (event) => {
      debug(`Error global: ${event.message}`);
    });
    
    // Iniciar la aplicaci√≥n cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', initApp);
    
    // Component para detectar gestos en A-Frame
    AFRAME.registerComponent('gesture-detector', {
      init: function () {
        this.el.sceneEl.addEventListener('click', (evt) => {
          debug('Click en escena detectado');
          
          // Comprobar si el click fue en el video
          if (appState.markerVisible && !appState.audioUnlocked) {
            unlockAudio();
          }
        });
      }
    });
  </script>
</body>
</html>