<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  
  <link rel="stylesheet" href="config-sensores.css">
  <link rel="stylesheet" href="UI-personalizado.css">
  <style>
    /* Contenedores para los diferentes tipos de contenido */
    .content-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      display: none;
      z-index: 9999;
    }

    /* Estilo para el reproductor de YouTube */
    .youtube-player {
      width: 90vw;
      max-width: 600px;
      aspect-ratio: 16/9;
      height: auto;
      margin: 0 auto;
      background: #000;
      border: 2px solid #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      pointer-events: auto;
      position: relative;
    }

    /* Estilo para el applet de GeoGebra */
    .geogebra-player {
      width: 90vw;
      max-width: 600px;
      aspect-ratio: 4/3;
      height: auto;
      margin: 0 auto;
      background: #fff;
      border: 2px solid #ddd;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      pointer-events: auto;
      position: relative;
      margin: 0 auto;
    }

    /* Estilo para el mensaje de página web */
    .webpage-alert {
      height: 90vw;
      max-height: 500px;
      aspect-ratio: 3/4;
      width: auto;
      margin: 20px auto;
      padding: 25px;
      background: #fff;
      border-radius: 8px;
      border: 2px solid #e74c3c;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      text-align: center;
      pointer-events: auto;
      position: relative;
      box-sizing: border-box;
    }

    .webpage-alert p {
      margin-bottom: 25px;
      color: #333;
      font-size: 16px;
      line-height: 1.5;
    }

    /* Estilo para el reproductor de audio */
    .audio-player {
      width: 90vw;
      max-width: 400px;
      background: rgba(0, 0, 0, 0.85);
      border-radius: 10px;
      padding: 20px;
      color: white;
      pointer-events: auto;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .audio-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-top: 15px;
    }

    .audio-btn {
      background: #4CAF50;
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .audio-btn:hover {
      background: #45a049;
    }

    .audio-progress {
      width: 100%;
      margin: 15px 0;
    }

    .audio-time {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #ccc;
    }

    .audio-title {
      text-align: center;
      margin-bottom: 10px;
      font-weight: bold;
    }

    /* Botones comunes */
    .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(255, 0, 0, 0.7);
      color: white;
      border: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .alert-btn {
      padding: 10px 20px;
      margin: 0 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .alert-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .open-browser-btn {
      background: #2ecc71;
      color: white;
    }

    .open-browser-btn:hover {
      background: #27ae60;
    }

    .cancel-btn {
      background: #e74c3c;
      color: white;
    }

    .cancel-btn:hover {
      background: #c0392b;
    }

    /* Personaliza el loader nativo de A-Frame */
    .a-canvas {
      background: transparent !important;
    }

    .a-loader-title {
      display: none;
      /* Oculta el texto 'Loading' */
    }

    .a-enter-ar-button,
    .a-enter-vr-button {
      opacity: 0 !important;
      pointer-events: none !important;
    }

    /* Elimina completamente el botón VR */
    .a-enter-vr {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }
    
    /* Loader para recursos pendientes */
    .resource-loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      z-index: 10001;
      display: none;
      text-align: center;
    }
    
    .resource-progress {
      width: 200px;
      height: 4px;
      background: rgba(255,255,255,0.2);
      margin: 15px auto;
      border-radius: 2px;
    }
    
    .resource-progress-bar {
      width: 0%;
      height: 100%;
      background: #4CAF50;
      border-radius: 2px;
      transition: width 0.3s;
    }
  </style>
</head>

<body>
  <a-scene mindar-image="imageTargetSrc: tarjetas/targets.mind;" color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-assets>
      <!-- Assets se cargarán dinámicamente -->
      <video id="youtube-video" autoplay loop crossorigin="anonymous" webkit-playsinline playsinline></video>
      <audio id="podcast-audio" preload="auto"></audio>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- Target 0: Video de YouTube -->
    <a-entity mindar-image-target="targetIndex: 0">
    </a-entity>

    <!-- Target 1: GeoGebra -->
    <a-entity mindar-image-target="targetIndex: 1">
    </a-entity>

    <!-- Target 2: Página web -->
    <a-entity mindar-image-target="targetIndex: 2">
    </a-entity>

    <!-- Target 3: Modelo 3D -->
    <a-entity mindar-image-target="targetIndex: 3">
      <a-gltf-model rotation="0 0 0" position="0 0 0" scale="0.5 0.5 0.5" src="#avatarModel"
        animation="property: position; to: 0 0 0; dur: 1000; easing: easeInOutQuad; loop: true; dir: alternate; enabled: false">
      </a-gltf-model>
    </a-entity>

    <!-- Target 4: Podcast -->
    <a-entity mindar-image-target="targetIndex: 4">
    </a-entity>
  </a-scene>

  <!-- Contenedor para YouTube -->
  <div id="youtube-container" class="content-container">
    <div class="youtube-player">
      <button class="close-btn" id="youtube-close-btn">X</button>
      <iframe id="youtube-iframe" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>
    </div>
  </div>

  <!-- Contenedor para GeoGebra -->
  <div id="geogebra-container" class="content-container">
    <div class="geogebra-player">
      <button class="close-btn" id="geogebra-close-btn">X</button>
      <iframe id="geogebra-iframe" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>
    </div>
  </div>

  <!-- Contenedor para Página Web -->
  <div id="webpage-container" class="content-container">
    <div class="webpage-alert" id="webpage-alert">
      <button class="close-btn" id="webpage-close-btn">X</button>
      <p>El sitio web no puede mostrarse directamente debido a políticas de seguridad. ¿Deseas abrirlo en tu navegador?
      </p>
      <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
        <button class="alert-btn open-browser-btn" id="open-browser-btn">Abrir en navegador</button>
        <button class="alert-btn cancel-btn" id="cancel-webpage-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Contenedor para Podcast -->
  <div id="podcast-container" class="content-container">
    <div class="audio-player">
      <button class="close-btn" id="podcast-close-btn">X</button>
      <div class="audio-title">Podcast</div>
      <input type="range" class="audio-progress" id="podcast-progress" min="0" max="100" value="0">
      <div class="audio-time">
        <span id="podcast-current-time">00:00</span>
        <span id="podcast-duration">00:00</span>
      </div>
      <div class="audio-controls">
        <button class="audio-btn" id="podcast-play-btn">▶</button>
        <button class="audio-btn" id="podcast-pause-btn">⏸</button>
        <button class="audio-btn" id="podcast-stop-btn">⏹</button>
      </div>
    </div>
  </div>

  <!-- Loader para recursos pendientes -->
  <div id="resource-loader" class="resource-loader">
    <div id="resource-message">Cargando recurso...</div>
    <div class="resource-progress">
      <div id="resource-progress-bar" class="resource-progress-bar"></div>
    </div>
  </div>

  <div id="ar-loader" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, rgba(10,30,50,0.8) 0%, rgba(0,0,20,0.9) 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 9999;
  color: white;
  font-family: 'Arial';
  transition: opacity 0.5s;
">
    <div style="text-align: center; max-width: 80%;">
      <h2 style="margin-bottom: 20px;">Preparando experiencia de Realidad Aumentada</h2>
      <p>Por favor espera mientras se cargan los recursos esenciales...</p>
      <div style="width: 200px; height: 4px; background: rgba(255,255,255,0.2); margin: 30px auto; border-radius: 2px;">
        <div id="loader-bar" style="width: 0%; height: 100%; background: #4CAF50; border-radius: 2px;"></div>
      </div>
    </div>
  </div>

  <script>
    // Configuración
    const CONTENT_CONFIG = {
      0: {
        type: "video",
        container: "youtube",
        youtubeId: "dayfz0ff1Mc",
        loaded: false
      },
      1: {
        type: "geogebra",
        container: "geogebra",
        appletId: "qzjfkvpm",
        loaded: false
      },
      2: {
        type: "webpage",
        container: "webpage",
        url: "https://wordwall.net/es/resource/12994896/n%C3%BAmeros-negativos-y-positivos",
        loaded: false
      },
      3: {
        type: "3d",
        modelUrl: "media/shiba/scene.gltf",
        loaded: false
      },
      4: {
        type: "podcast",
        container: "podcast",
        audioUrl: "sound/canto.mp3",
        loaded: false
      }
    };

    // Inicialización
    document.addEventListener('DOMContentLoaded', function () {
      // Configurar listeners para YouTube
      document.getElementById('youtube-close-btn').addEventListener('click', () => closeContent('youtube'));

      // Configurar listeners para GeoGebra
      document.getElementById('geogebra-close-btn').addEventListener('click', () => closeContent('geogebra'));

      // Configurar listeners para la página web
      document.getElementById('webpage-close-btn').addEventListener('click', handleWebpageClose);
      document.getElementById('cancel-webpage-btn').addEventListener('click', handleWebpageClose);
      document.getElementById('open-browser-btn').addEventListener('click', openExternalBrowser);

      // Configurar listeners para el podcast
      document.getElementById('podcast-close-btn').addEventListener('click', () => closeContent('podcast'));
      document.getElementById('podcast-play-btn').addEventListener('click', playPodcast);
      document.getElementById('podcast-pause-btn').addEventListener('click', pausePodcast);
      document.getElementById('podcast-stop-btn').addEventListener('click', stopPodcast);

      // Simular progreso de carga inicial
      const loader = document.getElementById('ar-loader');
      const loaderBar = document.getElementById('loader-bar');
      let progress = 0;

      const progressInterval = setInterval(() => {
        progress += Math.random() * 10;
        loaderBar.style.width = `${Math.min(progress, 90)}%`;
      }, 300);

      // Escuchar cuando la escena esté lista para mostrar la cámara
      const scene = document.querySelector('a-scene');
      scene.addEventListener('loaded', () => {
        clearInterval(progressInterval);
        loaderBar.style.width = '100%';
        
        // Ocultar loader después de un breve retraso
        setTimeout(() => {
          loader.style.opacity = '0';
          setTimeout(() => {
            loader.style.display = 'none';
          }, 500);
        }, 500);
        
        // Iniciar carga de recursos en segundo plano
        loadResourcesInBackground();
      });
    });

    // Carga de recursos en segundo plano
    function loadResourcesInBackground() {
      // Cargar modelo 3D
      load3DModel();
      
      // Cargar audio del podcast
      loadPodcastAudio();
      
      // Precargar iframes (no se pueden precargar realmente, pero los prepararemos)
      prepareIframes();
    }
    
    function load3DModel() {
      const modelConfig = CONTENT_CONFIG[3];
      if (modelConfig.loaded) return;
      
      const scene = document.querySelector('a-scene');
      const assets = document.querySelector('a-assets');
      
      // Crear elemento de asset para el modelo
      const modelAsset = document.createElement('a-asset-item');
      modelAsset.setAttribute('id', 'avatarModel');
      modelAsset.setAttribute('src', modelConfig.modelUrl);
      
      // Escuchar cuando el modelo se cargue
      modelAsset.addEventListener('loaded', () => {
        modelConfig.loaded = true;
        console.log('Modelo 3D cargado');
      });
      
      // Escuchar errores
      modelAsset.addEventListener('error', () => {
        console.error('Error al cargar el modelo 3D');
      });
      
      // Agregar a los assets
      assets.appendChild(modelAsset);
    }
    
    function loadPodcastAudio() {
      const podcastConfig = CONTENT_CONFIG[4];
      if (podcastConfig.loaded) return;
      
      const audio = document.getElementById('podcast-audio');
      audio.src = podcastConfig.audioUrl;
      
      audio.addEventListener('loadeddata', () => {
        podcastConfig.loaded = true;
        console.log('Audio del podcast cargado');
        setupPodcastPlayer();
      });
      
      audio.addEventListener('error', () => {
        console.error('Error al cargar el audio del podcast');
      });
    }
    
    function prepareIframes() {
      // Configurar YouTube
      const youtubeIframe = document.getElementById('youtube-iframe');
      youtubeIframe.src = `https://www.youtube.com/embed/${CONTENT_CONFIG[0].youtubeId}?autoplay=1&enablejsapi=1&controls=1`;
      CONTENT_CONFIG[0].loaded = true;
      
      // Configurar GeoGebra
      const geogebraIframe = document.getElementById('geogebra-iframe');
      geogebraIframe.src = `https://www.geogebra.org/material/iframe/id/${CONTENT_CONFIG[1].appletId}/width/1400/height/800/border/888888/sfsb/true/smb/false/stb/false/stbh/false/ai/false/asb/false/sri/false/rc/false/ld/false/sdz/false/ctl/false`;
      CONTENT_CONFIG[1].loaded = true;
      
      // La página web no necesita precarga
      CONTENT_CONFIG[2].loaded = true;
    }

    // Configuración del reproductor de podcast
    function setupPodcastPlayer() {
      const audio = document.getElementById('podcast-audio');
      const progress = document.getElementById('podcast-progress');
      const currentTime = document.getElementById('podcast-current-time');
      const duration = document.getElementById('podcast-duration');

      // Actualizar duración cuando esté disponible
      audio.addEventListener('loadedmetadata', () => {
        duration.textContent = formatTime(audio.duration);
      });

      // Actualizar progreso durante la reproducción
      audio.addEventListener('timeupdate', () => {
        progress.value = (audio.currentTime / audio.duration) * 100;
        currentTime.textContent = formatTime(audio.currentTime);
      });

      // Permitir saltar a diferentes partes del audio
      progress.addEventListener('input', () => {
        const seekTime = (progress.value / 100) * audio.duration;
        audio.currentTime = seekTime;
      });
    }

    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function playPodcast() {
      const audio = document.getElementById('podcast-audio');
      audio.play();
    }

    function pausePodcast() {
      const audio = document.getElementById('podcast-audio');
      audio.pause();
    }

    function stopPodcast() {
      const audio = document.getElementById('podcast-audio');
      audio.pause();
      audio.currentTime = 0;
    }

    // Eventos de MindAR
    const scene = document.querySelector('a-scene');
    scene.addEventListener('targetFound', event => {
      const targetIndex = event.target.getAttribute('mindar-image-target').targetIndex;
      const contentConfig = CONTENT_CONFIG[targetIndex];

      if (contentConfig && contentConfig.container) {
        if (!contentConfig.loaded) {
          showResourceLoader(`Cargando ${contentConfig.type}...`);
          return;
        }
        
        const container = document.getElementById(`${contentConfig.container}-container`);
        if (container) {
          container.style.display = 'block';
          container.style.pointerEvents = 'auto';

          if (targetIndex === 2) {
            document.getElementById('webpage-alert').style.display = 'block';
          }
        }
      }
    });
    
    scene.addEventListener('targetLost', event => {
      const targetIndex = event.target.getAttribute('mindar-image-target').targetIndex;
      const contentConfig = CONTENT_CONFIG[targetIndex];
      
      if (contentConfig && contentConfig.container) {
        const container = document.getElementById(`${contentConfig.container}-container`);
        if (container) {
          container.style.display = 'none';
        }
      }
      
      hideResourceLoader();
    });

    // Mostrar loader para recursos pendientes
    function showResourceLoader(message) {
      const loader = document.getElementById('resource-loader');
      const messageEl = document.getElementById('resource-message');
      const progressBar = document.getElementById('resource-progress-bar');
      
      messageEl.textContent = message;
      progressBar.style.width = '0%';
      loader.style.display = 'block';
      
      // Simular progreso (en una implementación real, usarías eventos de progreso reales)
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 10;
        progressBar.style.width = `${Math.min(progress, 100)}%`;
        
        if (progress >= 100) {
          clearInterval(interval);
          const targetConfig = getCurrentTargetConfig();
          if (targetConfig) {
            targetConfig.loaded = true;
            hideResourceLoader();
            
            // Mostrar el contenido ahora que está cargado
            const container = document.getElementById(`${targetConfig.container}-container`);
            if (container) {
              container.style.display = 'block';
              container.style.pointerEvents = 'auto';
            }
          }
        }
      }, 300);
    }
    
    function hideResourceLoader() {
      const loader = document.getElementById('resource-loader');
      loader.style.display = 'none';
    }
    
    function getCurrentTargetConfig() {
      // Esta función debería determinar qué marcador está actualmente activo
      // En una implementación real, necesitarías rastrear el estado actual
      // Aquí es un ejemplo simplificado
      for (let i = 0; i < 5; i++) {
        const entity = document.querySelector(`a-entity[mindar-image-target="targetIndex: ${i}"]`);
        if (entity && entity.getAttribute('visible')) {
          return CONTENT_CONFIG[i];
        }
      }
      return null;
    }

    // Funciones de control
    function closeContent(type) {
      const container = document.getElementById(`${type}-container`);
      if (container) {
        container.style.display = 'none';

        if (type === 'youtube') {
          const iframe = document.getElementById('youtube-iframe');
          if (iframe.contentWindow) {
            iframe.contentWindow.postMessage(JSON.stringify({
              event: 'command',
              func: 'pauseVideo',
              args: []
            }), '*');
          }
        } else if (type === 'podcast') {
          stopPodcast();
        }
      }
    }

    function handleWebpageClose() {
      closeContent('webpage');
    }

    function openExternalBrowser() {
      try {
        // Intenta abrir en nueva pestaña
        const newWindow = window.open(CONTENT_CONFIG[2].url, '_blank');

        // Fallback si el navegador bloquea la ventana emergente
        if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
          window.location.href = CONTENT_CONFIG[2].url;
        }
      } catch (e) {
        console.error('Error al abrir el navegador:', e);
        window.location.href = CONTENT_CONFIG[2].url;
      }

      // Cerrar el contenedor de la página web
      closeContent('webpage');
    }
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }).catch(err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>

  <script src="config-sensores.js"></script>
  <script src="UI-personalizado.js"></script>
</body>

</html>