<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Proyecto AR Web</title>
    <!-- A-Frame y AR.js para la experiencia de AR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- Gestos para A-Frame -->
    <script>
        // Componente para detectar gestos
        AFRAME.registerComponent('gesture-detector', {
            schema: {
                element: { default: '' }
            },
            init: function() {
                this.targetElement = this.data.element && document.querySelector(this.data.element);
                if (!this.targetElement) {
                    this.targetElement = this.el;
                }
                this.internalState = {
                    previousState: null
                };
                this.emitGestureEvent = this.emitGestureEvent.bind(this);
                this.targetElement.addEventListener('touchstart', this.emitGestureEvent);
                this.targetElement.addEventListener('touchend', this.emitGestureEvent);
                this.targetElement.addEventListener('touchmove', this.emitGestureEvent);
            },
            remove: function() {
                this.targetElement.removeEventListener('touchstart', this.emitGestureEvent);
                this.targetElement.removeEventListener('touchend', this.emitGestureEvent);
                this.targetElement.removeEventListener('touchmove', this.emitGestureEvent);
            },
            emitGestureEvent(event) {
                const currentState = this.getTouchState(event);
                const previousState = this.internalState.previousState;
                const gestureContinues = previousState && currentState && 
                    currentState.touchCount === previousState.touchCount;
                const gestureEnded = previousState && !gestureContinues;
                const gestureStarted = currentState && !gestureContinues;
                
                if (gestureEnded) {
                    const eventName = this.getEventPrefix(previousState.touchCount) + 'fingerend';
                    this.targetElement.emit(eventName, previousState);
                    this.internalState.previousState = null;
                }
                
                if (gestureStarted) {
                    currentState.startTime = performance.now();
                    currentState.startPosition = currentState.position;
                    currentState.startSpread = currentState.spread;
                    const eventName = this.getEventPrefix(currentState.touchCount) + 'fingerstart';
                    this.targetElement.emit(eventName, currentState);
                    this.internalState.previousState = currentState;
                }
                
                if (gestureContinues) {
                    const eventDetail = {
                        positionChange: {
                            x: currentState.position.x - previousState.position.x,
                            y: currentState.position.y - previousState.position.y
                        }
                    };
                    
                    if (currentState.spread) {
                        eventDetail.spreadChange = currentState.spread - previousState.spread;
                    }
                    
                    // Update state with new data
                    Object.assign(previousState, currentState);
                    
                    // Add state data to event detail
                    Object.assign(eventDetail, previousState);
                    
                    const eventName = this.getEventPrefix(currentState.touchCount) + 'fingermove';
                    this.targetElement.emit(eventName, eventDetail);
                }
            },
            getTouchState: function(event) {
                if (event.touches.length === 0) {
                    return null;
                }
                
                // Convert touches to array to make finger identification more robust
                const touchList = [];
                for (let i = 0; i < event.touches.length; i++) {
                    touchList.push(event.touches[i]);
                }
                
                const touchState = {
                    touchCount: touchList.length
                };
                
                // Calculate center position of all current touches
                const centerPositionRawX = touchList.reduce((sum, touch) => sum + touch.clientX, 0) / touchList.length;
                const centerPositionRawY = touchList.reduce((sum, touch) => sum + touch.clientY, 0) / touchList.length;
                
                touchState.positionRaw = { x: centerPositionRawX, y: centerPositionRawY };
                
                // Scale touch position to canvas coordinates
                touchState.position = { x: centerPositionRawX / window.innerWidth, y: centerPositionRawY / window.innerHeight };
                
                // Calculate spread of touches
                if (touchList.length >= 2) {
                    touchState.spread = Math.sqrt(
                        Math.pow(touchList[0].clientX - touchList[1].clientX, 2) +
                        Math.pow(touchList[0].clientY - touchList[1].clientY, 2)
                    );
                }
                
                return touchState;
            },
            getEventPrefix(touchCount) {
                const numberNames = ['one', 'two', 'three', 'many'];
                return numberNames[Math.min(touchCount, 4) - 1];
            }
        });
    </script>
    
    <!-- JQuery para manipulación del DOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            color: white;
            text-align: center;
        }
        
        #start-button {
            background-color: white;
            color: #6e8efb;
            border: none;
            padding: 15px 32px;
            margin-top: 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        #start-button:hover {
            background-color: #f1f1f1;
            transform: scale(1.05);
        }
        
        #back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: none;
        }
        
        #debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background-color: rgba(0, 0, 0, 0.35);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }
        
        #minimize-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
        }
        
        .minimized {
            height: 30px !important;
            overflow: hidden !important;
        }
        
        #debug-content {
            margin-top: 10px;
        }
        
        .geogebra-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            display: none;
        }
        
        .debug-message {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <!-- Pantalla de inicio -->
    <div id="splash-screen">
        <h1>Bienvenido a la Experiencia AR</h1>
        <p>Apunta tu cámara a los marcadores para ver el contenido en realidad aumentada</p>
        <button id="start-button">Comenzar Experiencia AR</button>
    </div>
    
    <!-- Botón de retroceso -->
    <button id="back-button">← Volver</button>
    
    <!-- Panel de depuración -->
    <div id="debug-panel">
        <button id="minimize-button">-</button>
        <div id="debug-title">Debug Console</div>
        <div id="debug-content"></div>
    </div>
    
    <!-- A-Frame Scene para AR -->
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;" vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true; precision: medium;" gesture-detector>
        <!-- Agregar Assets -->
        <a-assets>
            <video id="video-asset" src="media/video.mp4" preload="auto" loop crossorigin="anonymous"></video>
        </a-assets>
        
        <!-- Marcador 1: Video -->
        <a-marker id="marker1" preset="hiro">
            <a-video src="#video-asset" width="2" height="1.5" position="0 0.5 0" rotation="-90 0 0"></a-video>
        </a-marker>
        
        <!-- Marcador 2: Modelo 3D -->
        <a-marker id="marker2" preset="kanji">
            <a-entity id="model" gltf-model="media/duck.gltf" scale="0.5 0.5 0.5" position="0 0.5 0" rotation="-90 0 0" animation="property: rotation; to: -90 360 0; loop: true; dur: 10000; easing: linear"></a-entity>
        </a-marker>
        
        <!-- Marcador 3: GeoGebra -->
        <a-marker id="marker3" preset="pattern" type="pattern" url="markers/mark3.patt">
            <a-plane width="3" height="3" position="0 0 0" rotation="-90 0 0" color="#FFFFFF" id="geogebra-plane"></a-plane>
        </a-marker>
        
        <!-- Cámara -->
        <a-entity camera></a-entity>
    </a-scene>
    
    <!-- Contenedor para GeoGebra -->
    <div class="geogebra-container" id="geogebra-container">
        <iframe src="https://www.geogebra.org/m/s5u5g6yr" width="100%" height="100%" frameborder="0"></iframe>
    </div>
    
    <script>
        $(document).ready(function() {
            // Variables para seguimiento
            let debugMinimized = false;
            let cameraCount = 0;
            let markersDetected = {
                'marker1': false,
                'marker2': false,
                'marker3': false
            };
            
            // Función para agregar mensajes al panel de debug
            function addDebugMessage(message) {
                const time = new Date().toLocaleTimeString();
                $("#debug-content").append(`<div class="debug-message">[${time}] ${message}</div>`);
                // Auto-scroll hacia abajo
                const debugContent = document.getElementById('debug-content');
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            // Comprobar compatibilidad del dispositivo
            function checkDeviceCapabilities() {
                // Verificar si el navegador soporta WebRTC
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    addDebugMessage("✓ Dispositivo compatible con WebRTC");
                    
                    // Verificar WebGL
                    let canvas = document.createElement('canvas');
                    let gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    if (gl && gl instanceof WebGLRenderingContext) {
                        addDebugMessage("✓ Soporte WebGL detectado");
                    } else {
                        addDebugMessage("✗ WebGL no soportado - La experiencia AR puede ser limitada");
                    }
                    
                    // Verificar cámaras disponibles
                    if (navigator.mediaDevices.enumerateDevices) {
                        navigator.mediaDevices.enumerateDevices()
                            .then(function(devices) {
                                cameraCount = devices.filter(device => device.kind === 'videoinput').length;
                                addDebugMessage(`ℹ Cámaras detectadas: ${cameraCount}`);
                            })
                            .catch(function(err) {
                                addDebugMessage("✗ Error al enumerar dispositivos: " + err);
                            });
                    }
                } else {
                    addDebugMessage("✗ WebRTC no soportado - La AR no funcionará en este dispositivo");
                }
                
                // Verificar giroscopio
                if (window.DeviceOrientationEvent) {
                    addDebugMessage("✓ API de orientación de dispositivo disponible");
                } else {
                    addDebugMessage("✗ Sin giroscopio o API de orientación - Puede afectar la experiencia AR");
                }
                
                // Verificar acelerómetro
                if (window.DeviceMotionEvent) {
                    addDebugMessage("✓ API de movimiento de dispositivo disponible");
                } else {
                    addDebugMessage("✗ Sin acelerómetro o API de movimiento");
                }
            }
            
            // Botón de inicio para solicitar permisos de cámara y comenzar AR
            $("#start-button").click(function() {
                // Solicitar permiso de cámara
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        // Ocultar pantalla de bienvenida
                        $("#splash-screen").fadeOut();
                        
                        // Mostrar botón de retroceso y panel de debug
                        $("#back-button").fadeIn();
                        $("#debug-panel").fadeIn();
                        
                        // Inicializar mensajes de debug
                        addDebugMessage("✓ Permiso de cámara concedido");
                        addDebugMessage("ℹ Iniciando experiencia AR");
                        addDebugMessage("ℹ Buscando marcadores...");
                        
                        // Verificar capacidades del dispositivo
                        checkDeviceCapabilities();
                        
                        // Detener el stream ya que AR.js manejará la cámara
                        stream.getTracks().forEach(track => track.stop());
                    })
                    .catch(function(err) {
                        addDebugMessage("✗ Error al obtener acceso a la cámara: " + err);
                        alert("Se requiere acceso a la cámara para la experiencia AR. Por favor, permite el acceso.");
                    });
            });
            
            // Botón de retroceso para volver a la pantalla de inicio
            $("#back-button").click(function() {
                // Primero pausar cualquier video que se esté reproduciendo
                $("a-video").each(function() {
                    const videoEl = this.components.material.material.map.image;
                    if (videoEl && !videoEl.paused) {
                        videoEl.pause();
                    }
                });
                
                // Recargar la página para asegurarnos de reiniciar correctamente la AR
                location.reload();
                
                /* La siguiente funcionalidad se comenta porque es más seguro recargar la página
                $("#splash-screen").fadeIn();
                $("#back-button").hide();
                $("#debug-panel").hide();
                $("#geogebra-container").hide();
                
                // Limpiar mensajes de debug
                $("#debug-content").empty();
                
                // Resetear estados
                markersDetected = {
                    'marker1': false,
                    'marker2': false,
                    'marker3': false
                };
                */
            });
            
            // Minimizar/maximizar panel de debug
            $("#minimize-button").click(function() {
                debugMinimized = !debugMinimized;
                if (debugMinimized) {
                    $("#debug-panel").addClass("minimized");
                    $("#minimize-button").text("+");
                    $("#debug-content").hide();
                } else {
                    $("#debug-panel").removeClass("minimized");
                    $("#minimize-button").text("-");
                    $("#debug-content").show();
                }
            });
            
            // Detección de marcadores
            $("a-marker").each(function() {
                const markerId = $(this).attr("id");
                
                // Evento cuando se detecta un marcador
                $(this).on("markerFound", function() {
                    if (!markersDetected[markerId]) {
                        markersDetected[markerId] = true;
                        
                        // Mostrar qué marcador fue detectado con información más detallada
                        if (markerId === "marker1") {
                            addDebugMessage(`✓ Marcador Hiro (${markerId}) detectado`);
                        } else if (markerId === "marker2") {
                            addDebugMessage(`✓ Marcador Kanji (${markerId}) detectado`);
                        } else {
                            addDebugMessage(`✓ Marcador ${markerId} detectado`);
                        }
                        
                        // Acciones específicas según el marcador
                        if (markerId === "marker1") {
                            // Iniciar el video
                            const videoEl = document.querySelector('#video-asset');
                            if (videoEl && videoEl.paused) {
                                videoEl.play().then(() => {
                                    addDebugMessage("ℹ Reproduciendo video correctamente");
                                }).catch(err => {
                                    addDebugMessage("✗ Error al reproducir video: " + err);
                                });
                            }
                        } else if (markerId === "marker2") {
                            addDebugMessage("ℹ Mostrando modelo 3D con animación");
                        } else if (markerId === "marker3") {
                            // Mostrar applet GeoGebra
                            $("#geogebra-container").fadeIn();
                            addDebugMessage("ℹ Cargando applet GeoGebra");
                        }
                    }
                });
                
                // Evento cuando se pierde un marcador
                $(this).on("markerLost", function() {
                    if (markersDetected[markerId]) {
                        markersDetected[markerId] = false;
                        addDebugMessage(`ℹ Marcador ${markerId} perdido`);
                        
                        // Pausar video si estaba reproduciéndose
                        if (markerId === "marker1") {
                            const videoEl = document.querySelector('#video-asset');
                            if (videoEl && !videoEl.paused) {
                                videoEl.pause();
                                addDebugMessage("ℹ Video pausado");
                            }
                        } else if (markerId === "marker3") {
                            // Ocultar applet GeoGebra
                            $("#geogebra-container").fadeOut();
                            addDebugMessage("ℹ Applet GeoGebra oculto");
                        }
                    }
                });
            });
            
            // Manejar eventos de resize
            $(window).resize(function() {
                addDebugMessage("ℹ Cambio de tamaño de ventana detectado");
            });
            
            // Manejar errores de carga de recursos
            $("a-assets").on("error", function(event) {
                addDebugMessage("✗ Error al cargar recurso: " + event.target.src);
            });
        });
    </script>
</body>
</html>