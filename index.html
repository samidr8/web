<!DOCTYPE html>
<html lang="es">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="config-sensores.css">
  <link rel="stylesheet" href="UI-personalizado.css">
</head>
<body>
  <a-scene mindar-image="imageTargetSrc: tarjetas/targets.mind;"
           color-space="sRGB"
           renderer="colorManagement: true, physicallyCorrectLights"
           vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: false">
    <a-assets id="main-assets">
      <!-- NO hay assets vacíos aquí -->
    </a-assets>
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    <a-entity mindar-image-target="targetIndex: 0"></a-entity>
    <a-entity mindar-image-target="targetIndex: 1"></a-entity>
    <a-entity mindar-image-target="targetIndex: 2"></a-entity>
    <a-entity id="target3-entity" mindar-image-target="targetIndex: 3"></a-entity>
    <a-entity mindar-image-target="targetIndex: 4"></a-entity>
  </a-scene>

  <!-- Loader AR -->
  <div id="ar-loader" style="
    position: fixed;top: 0;left: 0;width: 100%;height: 100%;
    background: linear-gradient(135deg, rgba(10,30,50,0.8) 0%, rgba(0,0,20,0.9) 100%);
    display: flex;justify-content: center;align-items: center;flex-direction: column;
    z-index: 9999;color: white;font-family: 'Arial';transition: opacity 0.5s;">
    <div style="text-align: center; max-width: 80%;">
      <h2 style="margin-bottom: 20px;">Preparando experiencia de Realidad Aumentada</h2>
      <p>Por favor espera mientras se cargan los recursos...</p>
      <div style="width: 200px; height: 4px; background: rgba(255,255,255,0.2); margin: 30px auto; border-radius: 2px;">
        <div id="loader-bar" style="width: 0%; height: 100%; background: #4CAF50; border-radius: 2px;"></div>
      </div>
    </div>
  </div>

  <!-- Scripts principales al final -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.0.1/dist/aframe-extras.min.js" defer></script>
  <script src="config-sensores.js" defer></script>
  <script src="UI-personalizado.js" defer></script>
  <script defer>
    // Service Worker (opcional)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker-caching.js')
        .then(reg => console.log('Service Worker registrado', reg))
        .catch(err => console.warn('SW error:', err));
    }

    // Recursos a descargar en segundo plano
    const AR_RESOURCES = {
      "3d": { url: "media/shiba/scene.gltf", loaded: false, assetId: "avatarModel" },
      "audio": { url: "sound/canto.mp3", loaded: false, assetId: "podcast-audio" }
    };

    // Loader y barra
    const loader = document.getElementById('ar-loader');
    const loaderBar = document.getElementById('loader-bar');

    // Función para añadir assets dinámicamente
    function addAsset(type, id, url) {
      const assets = document.getElementById('main-assets');
      let asset;
      if (type === '3d') {
        asset = document.createElement('a-asset-item');
        asset.setAttribute('id', id);
        asset.setAttribute('src', url);
      } else if (type === 'audio') {
        asset = document.createElement('audio');
        asset.setAttribute('id', id);
        asset.setAttribute('src', url);
        asset.setAttribute('preload', 'auto');
      }
      assets.appendChild(asset);
    }

    // Descargar recursos AR en segundo plano
    function descargarRecursosAR(onProgress, onAllReady) {
      const keys = Object.keys(AR_RESOURCES);
      let loadedCount = 0;
      keys.forEach((key, idx) => {
        fetch(AR_RESOURCES[key].url)
          .then(resp => {
            if (!resp.ok) throw new Error("Error al cargar " + AR_RESOURCES[key].url);
            AR_RESOURCES[key].loaded = true;
            // Añadir dinámicamente
            if (key === "3d") {
              addAsset('3d', AR_RESOURCES[key].assetId, AR_RESOURCES[key].url);
            } else if (key === "audio") {
              addAsset('audio', AR_RESOURCES[key].assetId, AR_RESOURCES[key].url);
            }
            loadedCount++;
            if (onProgress) onProgress(Math.round((loadedCount / keys.length) * 100));
            if (loadedCount === keys.length && onAllReady) onAllReady();
          })
          .catch(err => {
            console.warn("No se pudo descargar", AR_RESOURCES[key].url, err);
            loadedCount++;
            if (onProgress) onProgress(Math.round((loadedCount / keys.length) * 100));
            if (loadedCount === keys.length && onAllReady) onAllReady();
          });
      });
    }

    // Cuando la escena esté lista, inicia la descarga en segundo plano
    document.addEventListener('DOMContentLoaded', function () {
      document.querySelector('a-scene').addEventListener('loaded', () => {
        setTimeout(() => {
          descargarRecursosAR((percent) => {
            loaderBar.style.width = percent + '%';
          }, () => {
            // Cuando todos los recursos estén listos, actualiza visibilidad del modelo 3D
            loader.style.opacity = '0';
            setTimeout(() => { loader.style.display = 'none'; }, 500);

            // Mostrar modelo 3D cuando ya exista el asset y el marcador se enfoque
            // (esto lo gestiona abajo en onTargetFound)
          });
        }, 300);
      });
    });

    // Mostrar barra y mensaje si el usuario detecta el marcador antes de que el recurso esté listo
    function onTargetFound(targetIndex) {
  let pendiente = false;
  let mensajeCargando = '';
  if (targetIndex == 3 && !AR_RESOURCES["3d"].loaded) {
    mensajeCargando = 'El modelo 3D aún se está cargando...';
    pendiente = true;
  }
  if (targetIndex == 4 && !AR_RESOURCES["audio"].loaded) {
    mensajeCargando = 'El audio aún se está cargando...';
    pendiente = true;
  }
  if (pendiente) {
    loader.style.opacity = '1';
    loader.style.display = 'flex';
    loader.querySelector('p').textContent = mensajeCargando;
  } else {
    loader.style.opacity = '0';
    setTimeout(() => { loader.style.display = 'none'; }, 500);

    // Mostrar modelo 3D solo cuando el asset y el marcador estén listos
    if (targetIndex == 3) {
      mostrarModelo3D();
    }
  }
}


// Cuando el recurso 3D está descargado y se detecta el marcador:
function mostrarModelo3D() {
  const parent = document.getElementById('target3-entity');
  if (!parent) return; // Seguridad extra

  if (document.getElementById('gltf-model')) return;

  let asset = document.getElementById('avatarModel');
  if (!asset) {
    asset = document.createElement('a-asset-item');
    asset.setAttribute('id', 'avatarModel');
    asset.setAttribute('src', AR_RESOURCES["3d"].url);
    document.getElementById('main-assets').appendChild(asset);
  }

  // Espera un ciclo para asegurar que el asset está en el DOM antes de crear el modelo
  setTimeout(() => {
    const model = document.createElement('a-gltf-model');
    model.setAttribute('id', 'gltf-model');
    model.setAttribute('src', '#avatarModel');
    model.setAttribute('rotation', '0 0 0');
    model.setAttribute('position', '0 0 0');
    model.setAttribute('scale', '0.5 0.5 0.5');
    parent.appendChild(model);
  }, 50); // 50 ms para asegurar el DOM update
}


    // Eventos de MindAR
    window.addEventListener('DOMContentLoaded', () => {
      const scene = document.querySelector('a-scene');
      scene.addEventListener('targetFound', event => {
        const targetIndex = event.target.getAttribute('mindar-image-target').targetIndex;
        onTargetFound(targetIndex);
      });
    });
  </script>
</body>
</html>
