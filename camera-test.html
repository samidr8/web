
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Test de cámara básico</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #333;
            color: white;
            font-family: Arial, sans-serif;
        }
        #videoElement {
            width: 100%;
            height: auto;
            max-height: 80vh;
            background-color: #666;
        }
        #controls {
            padding: 15px;
            text-align: center;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #logElement {
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            max-height: 20vh;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <video id="videoElement" autoplay playsinline></video>
    <div id="controls">
        <button id="startCamera">Iniciar cámara trasera</button>
        <button id="startFrontCamera">Iniciar cámara frontal</button>
        <button id="switchCamera">Cambiar cámara</button>
    </div>
    <div id="logElement">Logs aparecerán aquí...</div>

    <script>
        // Elementos del DOM
        const videoElement = document.getElementById('videoElement');
        const startButton = document.getElementById('startCamera');
        const startFrontButton = document.getElementById('startFrontCamera');
        const switchButton = document.getElementById('switchCamera');
        const logElement = document.getElementById('logElement');

        // Variables para tracking
        let currentStream = null;
        let currentFacingMode = 'environment'; // 'environment' = trasera, 'user' = frontal

        // Función para agregar logs
        function log(message) {
            const currentTime = new Date().toLocaleTimeString();
            logElement.innerHTML += `<div>[${currentTime}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // Función para detener la cámara actual
        function stopCurrentCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => {
                    track.stop();
                });
                currentStream = null;
                log('Cámara detenida');
            }
        }

        // Función para iniciar la cámara con configuración específica
        async function startCamera(facingMode = 'environment') {
            try {
                // Detener cámara actual si existe
                stopCurrentCamera();
                
                log(`Intentando iniciar cámara ${facingMode === 'environment' ? 'trasera' : 'frontal'}...`);
                
                // Primera configuración - básica
                const basicConstraints = {
                    video: {
                        facingMode: facingMode
                    },
                    audio: false
                };

                try {
                    currentStream = await navigator.mediaDevices.getUserMedia(basicConstraints);
                    videoElement.srcObject = currentStream;
                    currentFacingMode = facingMode;
                    log(`Cámara ${facingMode} iniciada con configuración básica`);
                    listCameraCapabilities();
                    return;
                } catch (basicError) {
                    log(`Error con configuración básica: ${basicError.name} - ${basicError.message}`);
                    
                    // Segunda configuración - sin facingMode
                    try {
                        log('Intentando configuración sin facingMode...');
                        const simpleConstraints = {
                            video: true,
                            audio: false
                        };
                        currentStream = await navigator.mediaDevices.getUserMedia(simpleConstraints);
                        videoElement.srcObject = currentStream;
                        log('Cámara iniciada con configuración mínima');
                        listCameraCapabilities();
                        return;
                    } catch (simpleError) {
                        log(`Error con configuración mínima: ${simpleError.name} - ${simpleError.message}`);
                        throw simpleError;
                    }
                }
            } catch (error) {
                log(`ERROR CRÍTICO: ${error.name} - ${error.message}`);
                videoElement.style.backgroundColor = 'red';
                
                // Mostrar sugerencias específicas según el error
                if (error.name === 'NotReadableError') {
                    log('SUGERENCIAS:');
                    log('1. Cierre otras aplicaciones que usen la cámara');
                    log('2. Reinicie el dispositivo');
                    log('3. Verifique los permisos del navegador');
                    log('4. Use un navegador diferente (Chrome o Firefox)');
                }
            }
        }

        // Función para listar las características de la cámara actual
        function listCameraCapabilities() {
            if (!currentStream) return;
            
            const videoTrack = currentStream.getVideoTracks()[0];
            if (videoTrack) {
                log(`Cámara activa: ${videoTrack.label}`);
                
                const capabilities = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
                log(`Capacidades: ${JSON.stringify(capabilities)}`);
                
                const settings = videoTrack.getSettings ? videoTrack.getSettings() : {};
                log(`Configuración actual: ${JSON.stringify(settings)}`);
            }
        }

        // Función para enumerar todas las cámaras disponibles
        async function listAllCameras() {
            try {
                log('Enumerando dispositivos de cámara disponibles...');
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(device => device.kind === 'videoinput');
                
                if (cameras.length === 0) {
                    log('⚠️ No se encontraron cámaras en el dispositivo');
                    return;
                }
                
                log(`Se encontraron ${cameras.length} cámaras:`);
                cameras.forEach((camera, index) => {
                    log(`${index + 1}. ${camera.label || 'Cámara sin etiqueta'} (${camera.deviceId.substring(0, 8)}...)`);
                });
            } catch (error) {
                log(`Error enumerando cámaras: ${error.message}`);
            }
        }

        // Event Listeners
        startButton.addEventListener('click', () => {
            startCamera('environment');
        });

        startFrontButton.addEventListener('click', () => {
            startCamera('user');
        });

        switchButton.addEventListener('click', () => {
            startCamera(currentFacingMode === 'environment' ? 'user' : 'environment');
        });

        // Verificar soporte para mediaDevices
        window.addEventListener('load', () => {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                log('❌ getUserMedia no está soportado en este navegador');
                startButton.disabled = true;
                startFrontButton.disabled = true;
                switchButton.disabled = true;
            } else {
                log('✅ API getUserMedia disponible');
                
                // Verificar permisos existentes
                navigator.permissions.query({name: 'camera'})
                    .then(result => {
                        log(`Estado de permiso de cámara: ${result.state}`);
                    })
                    .catch(error => {
                        log(`No se pudo verificar permisos: ${error.message}`);
                    });
                
                // Listar cámaras disponibles
                listAllCameras();
            }
        });
    </script>
</body>
</html>