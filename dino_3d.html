<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Libro Interactivo AR</title>
    <!-- Bibliotecas actualizadas -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .arjs-loader div {
            text-align: center;
            font-size: 1.25em;
            color: white;
        }

        .debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            font-family: monospace;
            z-index: 1000;
            max-width: 80%;
            max-height: 30%;
            overflow-y: auto;
            transition: height 0.3s ease;
        }

        .debug-info.minimized {
            height: A20px;
            overflow: hidden;
        }

        .debug-header {
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            font-weight: bold;
        }

        /* Iframe para contenido web (formularios, GeoGebra, etc.) */
        .web-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background-color: white;
            z-index: 1000;
            border: none;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .close-button {
            position: absolute;
            top: -15px;
            right: -15px;
            background-color: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 18px;
            cursor: pointer;
            display: none;
            z-index: 1001;
        }

        /* Contenedor de video */
        .video-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 640px;
            z-index: 1000;
            display: none;
        }

        .video-container video {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* Evitar zoom en mobile */
        body {
            touch-action: manipulation;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <!-- Loader -->
    <div class="arjs-loader">
        <div>Cargando, por favor espere...</div>
    </div>

    <!-- Panel de depuraci√≥n -->
    <div class="debug-info">
        <div class="debug-header" onclick="toggleDebugPanel()">
            <span>Informaci√≥n de depuraci√≥n</span>
            <span class="toggle-btn">[-]</span>
        </div>
        <div class="debug-content">Iniciando...</div>
    </div>

    <!-- Bot√≥n de bloqueo -->
    <button id="lock-button"
        style="position: fixed; bottom: 10px; right: 10px; padding: 10px; background-color: rgba(0, 0, 0, 0.7); color: white; border: none; border-radius: 5px; z-index: 1000;">
        üîí Bloquear modelo
    </button>

    <!-- Contenedor para iframe (Formularios, GeoGebra, etc.) -->
    <iframe id="web-content" class="web-content" allowfullscreen></iframe>
    <button id="close-button" class="close-button" onclick="closeWebContent()">‚úï</button>

    <!-- Contenedor para videos -->
    <div id="video-container" class="video-container">
        <video id="ar-video" controls></video>
        <button class="close-button" onclick="closeVideo()">‚úï</button>
    </div>

    <!-- Escena A-Frame con configuraci√≥n NFT optimizada -->
    <a-scene vr-mode-ui="enabled: false;" renderer="logarithmicDepthBuffer: true; antialias: true;" embedded
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

        <!-- Los marcadores NFT se agregar√°n din√°micamente aqu√≠ -->
        <a-entity id="nft-markers-container"></a-entity>

        <!-- C√°mara -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Configuraci√≥n de marcadores y sus contenidos
        const markers = [
            {
                id: "dinosaurio",
                url: "https://samidr8.github.io/web/markers/dinosaurio",
                type: "3d-model",
                content: {
                    url: "https://samidr8.github.io/web/media/volcano.glb",
                    scale: "500 500 500",
                    position: "50 0 -150",
                    rotation: "0 0 0"
                }
            },
            {
                id: "video-marker",
                url: "https://samidr8.github.io/web/markers/zenon",
                type: "video",
                content: {
                    url: "https://www.youtube.com/watch?v=7B0Z_JaEGlU"
                }
            },
            {
                id: "formulario-marker",
                url: "https://samidr8.github.io/web/markers/formulario",
                type: "iframe",
                content: {
                    url: "https://forms.office.com/r/FLjQhrUKby"
                }
            },
            {
                id: "geogebra-marker",
                url: "https://samidr8.github.io/web/markers/geogebra",
                type: "iframe",
                content: {
                    url: "https://www.geogebra.org/m/DCDmYQ8z"
                }
            }
            // Puedes agregar m√°s marcadores aqu√≠ siguiendo el mismo formato
            //https://carnaux.github.io/NFT-Marker-Creator/#/
        ];

        let debugMinimized = false;
        let modelLocked = false;
        let lastValidPosition = { x: 50, y: 0, z: -150 };
        let currentMarkerId = null;

        // Funci√≥n para el panel de depuraci√≥n
        function toggleDebugPanel() {
            const debugPanel = document.querySelector('.debug-info');
            const toggleBtn = document.querySelector('.toggle-btn');
            debugMinimized = !debugMinimized;

            if (debugMinimized) {
                debugPanel.classList.add('minimized');
                toggleBtn.textContent = '[+]';
            } else {
                debugPanel.classList.remove('minimized');
                toggleBtn.textContent = '[-]';
            }
        }

        // Funci√≥n para escribir en el panel
        function log(message) {
            const debugContent = document.querySelector('.debug-content');
            const timestamp = new Date().toLocaleTimeString();
            debugContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugContent.scrollTop = debugContent.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // Funci√≥n para bloquear/desbloquear modelo
        function toggleModelLock() {
            modelLocked = !modelLocked;
            const lockButton = document.getElementById('lock-button');

            if (modelLocked) {
                lockButton.textContent = "üîì Desbloquear modelo";
                log("Modelo bloqueado en posici√≥n actual");

                // Guardar la posici√≥n actual
                const modelRoot = document.querySelector(`#model-root-${currentMarkerId}`);
                if (modelRoot) {
                    const currentPosition = modelRoot.getAttribute('position');
                    lastValidPosition = {
                        x: currentPosition.x,
                        y: currentPosition.y,
                        z: currentPosition.z
                    };
                }
            } else {
                lockButton.textContent = "üîí Bloquear modelo";
                log("Modelo desbloqueado - seguir√° el marcador");
            }
        }

        // Funci√≥n para mostrar contenido web (iframe)
        function showWebContent(url) {
            const iframe = document.getElementById('web-content');
            const closeButton = document.getElementById('close-button');

            iframe.src = url;
            iframe.style.display = 'block';
            closeButton.style.display = 'block';

            log(`Mostrando contenido web: ${url}`);
        }

        // Funci√≥n para cerrar contenido web
        function closeWebContent() {
            const iframe = document.getElementById('web-content');
            const closeButton = document.getElementById('close-button');

            iframe.src = '';
            iframe.style.display = 'none';
            closeButton.style.display = 'none';

            log('Contenido web cerrado');
        }

        // Funci√≥n para mostrar video
        function showVideo(url) {
            const videoContainer = document.getElementById('video-container');
            const video = document.getElementById('ar-video');

            video.src = url;
            videoContainer.style.display = 'block';

            log(`Reproduciendo video: ${url}`);
        }

        // Funci√≥n para cerrar video
        function closeVideo() {
            const videoContainer = document.getElementById('video-container');
            const video = document.getElementById('ar-video');

            video.pause();
            video.src = '';
            videoContainer.style.display = 'none';

            log('Video cerrado');
        }

        // Funci√≥n para activar contenido basado en el tipo de marcador
        // Funci√≥n mejorada para activar contenido basado en el tipo de marcador
        function activateMarkerContent(marker) {
            currentMarkerId = marker.id;
            log(`Activando contenido para marcador: ${marker.id}`);

            // Ocultar todo el contenido primero
            hideAllContent();

            // Mostrar t√≠tulo del contenido si existe
            if (marker.content.title) {
                showContentTitle(marker.content.title);
            }

            // Activar el contenido apropiado seg√∫n el tipo
            switch (marker.type) {
                case "3d-model":
                    // Los modelos 3D ya est√°n en la escena, solo necesitamos asegurarnos de que sean visibles
                    const modelEntity = document.querySelector(`#model-root-${marker.id}`);
                    if (modelEntity) {
                        modelEntity.setAttribute('visible', true);

                        // Mostrar el bot√≥n de bloqueo solo para modelos 3D
                        document.getElementById('lock-button').style.display = 'block';
                    }
                    break;

                case "video":
                    showVideo(marker.content.url);
                    // Ocultar bot√≥n de bloqueo para videos
                    document.getElementById('lock-button').style.display = 'none';
                    break;

                case "iframe":
                    showWebContent(marker.content.url);
                    // Ocultar bot√≥n de bloqueo para iframes
                    document.getElementById('lock-button').style.display = 'none';
                    break;

                default:
                    log(`Tipo de contenido desconocido: ${marker.type}`);
            }
        }

        // Funci√≥n para mostrar el t√≠tulo del contenido
        function showContentTitle(title) {
            // Crear elemento de t√≠tulo si no existe
            let titleEl = document.getElementById('content-title');
            if (!titleEl) {
                titleEl = document.createElement('div');
                titleEl.id = 'content-title';
                titleEl.style.position = 'fixed';
                titleEl.style.top = '20px';
                titleEl.style.left = '50%';
                titleEl.style.transform = 'translateX(-50%)';
                titleEl.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                titleEl.style.color = 'white';
                titleEl.style.padding = '10px 20px';
                titleEl.style.borderRadius = '20px';
                titleEl.style.fontFamily = 'Arial, sans-serif';
                titleEl.style.zIndex = '1000';
                document.body.appendChild(titleEl);
            }

            titleEl.textContent = title;
            titleEl.style.display = 'block';
        }

        // A√±adir a la funci√≥n hideAllContent
        function hideAllContent() {
            // Ocultar todos los modelos 3D
            document.querySelectorAll('[id^="model-root-"]').forEach(model => {
                model.setAttribute('visible', false);
            });

            // Cerrar contenido web
            closeWebContent();

            // Cerrar video
            closeVideo();

            // Ocultar t√≠tulo
            const titleEl = document.getElementById('content-title');
            if (titleEl) {
                titleEl.style.display = 'none';
            }
        }

        // Funci√≥n para crear marcadores NFT din√°micamente
        function createNFTMarkers() {
            const container = document.getElementById('nft-markers-container');

            markers.forEach(marker => {
                // Crear elemento a-nft para cada marcador
                const nftEl = document.createElement('a-nft');
                nftEl.setAttribute('id', `nft-${marker.id}`);
                nftEl.setAttribute('type', 'nft');
                nftEl.setAttribute('url', marker.url);
                nftEl.setAttribute('smooth', 'true');
                nftEl.setAttribute('smoothCount', '10');
                nftEl.setAttribute('smoothTolerance', '0.01');
                nftEl.setAttribute('smoothThreshold', '5');
                nftEl.setAttribute('raycaster', 'objects: .clickable');
                nftEl.setAttribute('emitevents', 'true');
                nftEl.setAttribute('cursor', 'fuse: false; rayOrigin: mouse;');

                // Si es un modelo 3D, crear la entidad del modelo
                if (marker.type === "3d-model") {
                    const modelRoot = document.createElement('a-entity');
                    modelRoot.setAttribute('id', `model-root-${marker.id}`);
                    modelRoot.setAttribute('position', marker.content.position);
                    modelRoot.setAttribute('visible', false); // Inicialmente oculto

                    const model = document.createElement('a-entity');
                    model.setAttribute('id', `model-${marker.id}`);
                    model.setAttribute('gltf-model', marker.content.url);
                    model.setAttribute('scale', marker.content.scale);
                    model.setAttribute('rotation', marker.content.rotation);

                    modelRoot.appendChild(model);
                    nftEl.appendChild(modelRoot);
                }

                // Agregar eventos al marcador
                nftEl.addEventListener('markerFound', function () {
                    log(`üéØ Marcador ${marker.id} encontrado`);

                    // Activar contenido para este marcador
                    activateMarkerContent(marker);

                    // Si el modelo est√° bloqueado (para modelos 3D)
                    if (modelLocked && marker.type === "3d-model") {
                        const modelRoot = document.querySelector(`#model-root-${marker.id}`);
                        if (modelRoot) {
                            modelRoot.setAttribute('position', lastValidPosition);
                        }
                    }
                });

                nftEl.addEventListener('markerLost', function () {
                    log(`‚ùå Marcador ${marker.id} perdido`);

                    // Si el modelo est√° bloqueado, mantener la √∫ltima posici√≥n
                    // No ocultamos el contenido para que el usuario pueda seguir interactuando
                    if (modelLocked && marker.type === "3d-model") {
                        const modelRoot = document.querySelector(`#model-root-${marker.id}`);
                        if (modelRoot) {
                            modelRoot.setAttribute('position', lastValidPosition);
                        }
                    }
                });

                // Agregar marcador al contenedor
                container.appendChild(nftEl);
            });

            log(`${markers.length} marcadores NFT creados`);
        }

        // Al cargar la p√°gina
        window.addEventListener('load', function () {
            log("P√°gina cargada, inicializando sistema AR");

            // Crear marcadores NFT
            createNFTMarkers();

            // Configurar bot√≥n de bloqueo
            document.getElementById('lock-button').addEventListener('click', toggleModelLock);

            // Ocultar el loader despu√©s de inicializaci√≥n
            setTimeout(() => {
                document.querySelector('.arjs-loader').style.display = 'none';
                log("Sistema AR inicializado");
            }, 3000);

            // Prevenir zoom en m√≥viles
            document.addEventListener('touchmove', function (e) {
                if (e.scale !== 1) { e.preventDefault(); }
            }, { passive: false });
        });
    </script>
</body>

</html>